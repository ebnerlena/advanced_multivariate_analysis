---
title: "Density estimation"
author: "Group 1: Pariente Antonio, Bosch Guillem, Ebner Lena"
date: "`r format(Sys.time(), '%d/%b/%Y')`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Histogram
## 1.
At the slides we have seen the following relationship

`f^h,(−i)(xi)=nn−1(f^h(xi)−K(0)nh)`

between the leave-one-out kernel density estimator `f^h,(−i)(x)` and the kernel density estimator 
using all the observations f^h(x), when both are evaluated at `xi`, one of the observed data.
Find a similar relationship between the histogram estimator of the density function `f^hist(x)` 
and its leave-one-out version, `f^hist,(−i)(x)`, when both are evaluated at `xi`.

```{r}
# f,(-i)(xi) = ((n*b*f^h(xi)-1)/(n-l)) - (l/b)
```

## 2.
Read the CD rate data set and call `x` the first column. 
```{r CDrate}
cdrate.df <-read.table("./01_assignment/cdrate.dat")
head(cdrate.df)
x <- cdrate.df[,1]
```

Then define
```{r}
A <- min(x)-.05*diff(range(x)) 
Z <- max(x)+.05*diff(range(x))
nbr <- 7
```
and plot the histogram of x as
```{r}
hx <- hist(x,breaks=seq(A,Z,length=nbr+1),freq=F)
```

The following sentence converts this histogram into a function that can be evaluated at any point of R, or at a vector of real numbers:
```{r}
hx_f <- stepfun(hx$breaks,c(0,hx$density,0))
```

Use `hx_f` to evaluate the histogram at the vector of observed data x. 
Then add the points (xi,f^hist(xi)), i=1,…,n, to the histogram you have plotted before.

```{r}
y=hx_f(x)

# TODO add points to plot
```
## 3.

Use the formula you have found before relating `f^hist(xi)` and `f^hist,(−i)(xi)` to compute `f^hist,(−i)(xi), i=1,…,n`. 
Then add the points `(xi,f^hist,(−i)(xi)), i=1,…,n,` to the previous plot.
```{r}
b = hx$breaks[2] - hx$breaks[1]
f = function(x) (x*length(x)*b-1)/(b*(length(x)-1))
hx_loocv=f(hx$density)

# TODO plot
```
## 4.
Compute the leave-one-out log-likelihood function corresponding to the previous histogram, 
at which `nbr=7` has been used.
```{r}
b = hx$breaks[2] - hx$breaks[1]
f = function(x) (x*length(x)*b-1)/(b*(length(x)-1))
hx_loocv=f(hx$density)
```

## 5.

**Choosing `nbr` by leave-one-out Cross Validation (looCV)**. 
Consider now the set `seq(1,15)` as possible values for `nbr`, the number of intervals of the histogram. 
For each of them compute the leave-one-out log-likelihood function (`looCV_log_lik`) for the corresponding histogram. 
Then plot the values of `looCV_log_lik` against the values of `nbr` and select the optimal value of `nbr` as that at which `looCV_log_lik` takes its maximum. Finally, plot the histogram of x using the optimal value of `nbr`.
```{r}
nbr = seq(1,15)
for(element in nrb) {
   hx <- hist(x,breaks=seq(A,Z,length=nbr+1),freq=F)
   for(k in seq(1,length(x))){
      # x= TODO 

   }
   

}
```

## 6. 
**Choosing `b` by looCV**. Let b be the common width of the bins of a histogram. Consider the set
```{r}
seq((Z-A)/15,(Z-A)/1,length=30)
```

as possible values for `b`. Select the value of `b` maximizing the leave-one-out log-likelihood function, and plot the corresponding histogram.
_NOTE_: To avoid errors, use the following sintax for computing a histogram with bin width `b`
```{r}
hx <- hist(x,breaks=seq(A,Z+b,by=b), plot=F)
```
and this sentence to plot it:

```{r}
plot(hx,freq = FALSE)
```

```{r}
#  TODO
```

## 7.
Recycle the functions `graph.mixt` and `sim.mixt` defined at `density_estimation.Rmd` to generate 
n=100 data from

`f(x)=(3/4)N(x;m=0,s=1)+(1/4)N(x;m=3/2,s=1/3)`

Let `b` be the bin width of a histogram estimator of f(x) using the generated data. 
Select the value of b maximizing the leave-one-out log-likelihood function, and plot the corresponding histogram. Compare with the results obtained using the Scott’s formula:

`bScott=3.49St.Dev(X)n−1/3`.

```{r}
# TODO
```

# Kernel density estimation

# 8. 
Consider the vector `x` of data you have generated before from the mixture of two normals. 
Use the relationship

`f^h,(−i)(xi)=nn−1(f^h(xi)−K(0)nh)`

to select the value of `h` maximizing the leave-one-out log-likelihood function, and plot the corresponding kernel density estimator.
_NOTE_: The following sentences converts the kernel density estimator obtained 
with the function `density` into a function that can be evaluated at any point of R or at a vector of real numbers:
```{r}
kx <- density(x)
kx_f <- approxfun(x=kx$x, y=kx$y, method='linear', rule=2)
```
```{r}
# TODO
```