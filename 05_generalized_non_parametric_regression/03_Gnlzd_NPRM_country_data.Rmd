---
title: "Generalized Nonparametric Regression Model"
author: "Pedro Delicado"
date: "`r Sys.Date()`"
output:
  html_document:
    number_sections: yes
  pdf_document:
    fig_caption: yes
    number_sections: yes
subtitle: An Application to Country Development Data
classoption: a4paper
---
<!-- Comment lines are like this one -->
<!-- Use "\newpage" when you want a new page break in the pdf output  -->


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
# Country development data

We will be working with the file `HDI.2017.subset.csv` containing information on development indicators measured in 179 countries (Source: [Human Development Data (1990-2017)](http://hdr.undp.org/en/data), The Human Development Report Office, United Nations).

This file contains the following variables:

* `Life.expec` Life expectancy at birth.
* `Life.expec.f` Life expectancy at birth for females.
* `Life.expec.m` Life expectancy at birth for males.
* `le.fm` Difference `Life.expec.f` minus `Life.expec.m`.
* `Inf.Mort.rat` Infant mortality rate: The annual number of deaths of infants under one year of age per 1,000 live births in the same year.
* `Agric.employ.%` Employment in agriculture (% of total employment).


Reading the data and doing a scatterplot matrix of all variables:
```{r}
countries<-read.csv2(file="./05_generalized_non_parametric_regression/HDI.2017.subset.csv",row.names = 1)
attach(countries)
head(countries)
```

```{r}
summary(countries)
```

Matrix of scatterplots
```{r}
plot(countries[,2:7])
```


**Classify countries according to `Agric.employ..`.** 

The median value of variable `Agric.employ..` is `r median(Agric.employ..)`. 
Create a new binary variable `ind.agr` indicating for any country if variable `Agric.employ..` is lower than `r median(Agric.employ..)` (1) or not (0).
This new variable is a development indicator.

```{r}
ind.agr<-(Agric.employ.. < median(Agric.employ..))
```

**Classify countries according to `Life.expec`.** 

The median value of variable `Life.expec` is `r median(Life.expec)`. 
Create a new binary variable `ind.le` indicating for any country if variable `Life.expec` is greater than `r median(Life.expec)` (1) or not (0).
This new variable is a development indicator.


```{r}
ind.le<-(Life.expec > median(Life.expec))
```

# Local binary regression
Use `sm.binomial` from the R package `sm` to fit the proposed local binary regression models.
```{r, message=FALSE, warning=FALSE}
library(sm)
# help(sm.binomial)
```

In the graphic generated by `sm.binomial', compare your results with those obtained using 

i. a standard nonparametric regression fit (using `sm.regression`, for instance), and 
ii. a parametric fitting of a logistic regression model (using `glm`).
    

Fit a local binary regression modeling `ind.le`  as a function of `Inf.Mort.rat`.
```{r,warning=FALSE}
aux <- sm.binomial(Inf.Mort.rat,ind.le,h=10,display="none")
names(aux)
```

```{r,warning=FALSE}
aux <- sm.binomial(Inf.Mort.rat,ind.le,h=10)
sm.regression(Inf.Mort.rat,ind.le,h=10,col=4,add=T)
aux.glm <- glm(ind.le ~ Inf.Mort.rat,family=binomial)
pred <- predict(aux.glm, 
                newdata=data.frame(Inf.Mort.rat=aux$eval.points),
                type="response")
lines(aux$eval.points,pred,col=2)
legend("topright",c("Local binomial","Nonparametric regression","Logistic regression"),
       col=c(1,4,2),lty=1)
```

Fit a local binary regression modeling `ind.le`  as a function of `Agric.employ..`.

```{r,warning=FALSE}
aux <- sm.binomial(Agric.employ..,ind.le,h=3)
sm.regression(Agric.employ..,ind.le,h=3,col=4,add=T)
aux.glm <- glm(ind.le ~ Agric.employ..,family=binomial)
pred <- predict(aux.glm, 
                newdata=data.frame(Agric.employ..=aux$eval.points),
                type="response")
lines(aux$eval.points,pred,col=2)
legend("topright",c("Local binomial","Nonparametric regression","Logistic regression"),
       col=c(1,4,2),lty=1)
```


Fit a local binary regression modeling `ind.agr` as a function of `Life.expec`.
```{r,warning=FALSE}
aux <- sm.binomial(Life.expec,ind.agr,h=3)
sm.regression(Life.expec,ind.agr,h=3,col=4,add=T)
aux.glm <- glm(ind.agr ~ Life.expec,family=binomial)
pred <- predict(aux.glm, 
                newdata=data.frame(Life.expec=aux$eval.points),
                type="response")
lines(aux$eval.points,pred,col=2)
legend("left",c("Local binomial","Nonparametric regression","Logistic regression"),
       col=c(1,4,2),lty=1)
```

Fit a local binary regression modeling `ind.agr`  as a function of `le.fm`.

```{r,warning=FALSE}
aux <- sm.binomial(le.fm,ind.agr,h=3)
sm.regression(le.fm,ind.agr,h=3,col=4,add=T)
aux.glm <- glm(ind.agr ~ le.fm,family=binomial)
pred <- predict(aux.glm, 
                newdata=data.frame(le.fm=aux$eval.points),
                type="response")
lines(aux$eval.points,pred,col=2)
legend(7.25,.5,c("Local binomial","Nonparametric regression","Logistic regression"),
       col=c(1,4,2),lty=1)
```

Fit a local binary regression modeling `ind.agr` as a function of `Inf.Mort.rat`.
```{r,warning=FALSE}
aux <- sm.binomial(Inf.Mort.rat,ind.agr,h=15)
sm.regression(Inf.Mort.rat,ind.agr,h=15,col=4,add=T)
aux.glm <- glm(ind.agr ~ Inf.Mort.rat,family=binomial)
pred <- predict(aux.glm, 
                newdata=data.frame(Inf.Mort.rat=aux$eval.points),
                type="response")
lines(aux$eval.points,pred,col=2)
legend(52.1,.6,c("Local binomial","Nonparametric regression","Logistic regression"),
       col=c(1,4,2),lty=1)
```

# Local Poisson regression
Variable `le.fm` always takes non-negative values. Define `le.fm.r` as the rounded value of `le.fm` and plot its histogram:
```{r}
le.fm.r <- round(le.fm)
hist(le.fm.r,br=40)
```



Use `sm.poisson` from the R package `sm` to fit the proposed local Poisson regression models.
```{r, message=FALSE, warning=FALSE}
# help(sm.poisson)
```

In the graphic generated by `sm.poison', compare your results with those obtained using 

i. a standard nonparametric regression fit (using `sm.regression`, for instance), and 
ii. a parametric fitting of a Poisson Generalized Linear Model (using `glm`).
    

Fit a local Poisson regression modeling `le.fm.r`  as a function of `Inf.Mort.rat`.

```{r}
# in local poisson we assure that lambda is always non negativ
aux <- sm.poisson(Inf.Mort.rat,le.fm.r,h=10, col=1)
sm.regression(Inf.Mort.rat,le.fm.r,h=10,col=4,add=T)
aux.glm <- glm(le.fm.r ~ Inf.Mort.rat,family=poisson) # fitting a poisoon function; could also be done with sm.poisson
pred <- predict(aux.glm, 
                newdata=data.frame(Inf.Mort.rat=aux$eval.points),
                type="response")
lines(aux$eval.points,pred,col=2)
legend("topright",c("Local Poisson regression","Nonparametric regression","GLM, family Poisson"), col=c(1,4,2),lty=1)
```

Fit a local Poisson regression modeling `le.fm.r`  as a function of `Life.expec`.

```{r}
aux <- sm.poisson(Life.expec,le.fm.r,h=3,col=1)
sm.regression(Life.expec,le.fm.r,h=3,col=4,add=T)
aux.glm <- glm(le.fm.r ~ Life.expec,family=poisson)
pred <- predict(aux.glm, 
                newdata=data.frame(Life.expec=aux$eval.points),
                type="response")
lines(aux$eval.points,pred,col=2)
legend("topleft",c("Local Poisson regression","Nonparametric regression","GLM, family Poisson"), col=c(1,4,2),lty=1)
```
